# AvantPro Backend

API para gerenciamento de usu√°rios com suporte a perfil completo, desenvolvida em Go usando arquitetura de tr√™s camadas.

## üìã Caracter√≠sticas

- **Autentica√ß√£o JWT**: Login, registro e recupera√ß√£o de senha com tokens JWT
- **Sistema de Organiza√ß√µes**: Cria√ß√£o, gerenciamento de membros e sistema de convites
- **Perfil de Usu√°rio**: Endere√ßo completo (rua, cidade, bairro, CEP) e telefone
- **Seguran√ßa**: Senhas criptografadas com bcrypt e autentica√ß√£o baseada em tokens
- **Valida√ß√£o**: Valida√ß√£o completa de dados usando go-playground/validator
- **Pagina√ß√£o e Ordena√ß√£o**: Lista paginada com ordena√ß√£o por diferentes campos
- **CORS**: Configura√ß√£o de CORS para integra√ß√£o com frontend
- **Documenta√ß√£o**: Swagger/OpenAPI gerado automaticamente
- **Testes**: Cobertura completa com testes unit√°rios, de reposit√≥rio e integra√ß√£o

## üõ† Tecnologias

- **Go 1.24**: Linguagem principal
- **Gin**: Framework web HTTP com middleware CORS
- **GORM**: ORM para PostgreSQL
- **PostgreSQL**: Banco de dados principal
- **JWT**: Autentica√ß√£o baseada em tokens (golang-jwt/jwt)
- **bcrypt**: Criptografia de senhas
- **Swagger**: Documenta√ß√£o da API
- **Testcontainers**: Testes com PostgreSQL real
- **UUID**: Chaves prim√°rias com PostgreSQL gen_random_uuid()

## üöÄ Endpoints da API

### Autentica√ß√£o

- `POST /api/v1/auth/login` - Fazer login e obter token JWT
- `POST /api/v1/auth/register` - Registrar novo usu√°rio e obter token
- `POST /api/v1/auth/password-reset` - Solicitar reset de senha
- `POST /api/v1/auth/password-reset/confirm` - Confirmar reset de senha com token

### Organiza√ß√µes

- `POST /api/v1/organizations` - Criar organiza√ß√£o
- `GET /api/v1/organizations/my` - Listar organiza√ß√µes criadas pelo usu√°rio
- `GET /api/v1/organizations/memberships` - Listar organiza√ß√µes onde √© membro
- `GET /api/v1/organizations/{id}` - Buscar organiza√ß√£o por ID
- `PUT /api/v1/organizations/{id}` - Atualizar organiza√ß√£o
- `DELETE /api/v1/organizations/{id}` - Deletar organiza√ß√£o
- `GET /api/v1/organizations/{id}/members` - Listar membros da organiza√ß√£o
- `PUT /api/v1/organizations/{id}/members/{userId}` - Atualizar role do membro
- `DELETE /api/v1/organizations/{id}/members/{userId}` - Remover membro
- `POST /api/v1/organizations/{id}/invites` - Convidar usu√°rio
- `GET /api/v1/organizations/{id}/invites` - Listar convites da organiza√ß√£o
- `POST /api/v1/organizations/invites/token/{token}/accept` - Aceitar convite
- `DELETE /api/v1/organizations/invites/id/{inviteId}` - Revogar convite
- `POST /api/v1/organizations/invites/id/{inviteId}/resend` - Reenviar convite

### Par√¢metros de Consulta (Lista)

- `page`: N√∫mero da p√°gina (padr√£o: 1)
- `limit`: Itens por p√°gina (padr√£o: 50, m√°x: 100)
- `sortBy`: Campo para ordena√ß√£o (name, username, createdAt, updatedAt)
- `sortOrder`: Ordem (asc, desc, padr√£o: desc)

## üìÅ Estrutura do Projeto

```
avantpro-backend/
‚îú‚îÄ‚îÄ cmd/server/          # Entry point da aplica√ß√£o
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/          # Configura√ß√£o baseada em ambiente
‚îÇ   ‚îú‚îÄ‚îÄ controllers/     # Controllers HTTP (auth, organization)
‚îÇ   ‚îú‚îÄ‚îÄ database/        # Conex√£o e migra√ß√µes PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ errors/          # Tratamento de erros RFC 7807
‚îÇ   ‚îú‚îÄ‚îÄ models/          # Domain models e DTOs
‚îÇ   ‚îú‚îÄ‚îÄ repositories/    # Data access layer
‚îÇ   ‚îî‚îÄ‚îÄ services/        # Business logic (auth, organization)
‚îú‚îÄ‚îÄ tests/integration/   # Testes de integra√ß√£o
‚îú‚îÄ‚îÄ docs/               # Documenta√ß√£o Swagger gerada
‚îú‚îÄ‚îÄ bin/                # Bin√°rios compilados
‚îú‚îÄ‚îÄ tmp/                # Arquivos tempor√°rios (air)
‚îú‚îÄ‚îÄ CLAUDE.md           # Instru√ß√µes para Claude Code
‚îú‚îÄ‚îÄ Makefile           # Comandos de desenvolvimento
‚îî‚îÄ‚îÄ go.mod             # Depend√™ncias Go
```

## üîß Configura√ß√£o

### Vari√°veis de Ambiente (.env)

```bash
# Environment
ENV=development

# Server
PORT=8080
TRUSTED_PROXIES=

# Database
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=avantpro_backend
DB_SSLMODE=disable

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=24h
```

### Seguran√ßa em Produ√ß√£o

- **Swagger UI**: Dispon√≠vel apenas em `ENV=development`
- **JWT Secret**: OBRIGAT√ìRIO alterar `JWT_SECRET` em produ√ß√£o
- **Senhas**: Sempre criptografadas com bcrypt
- **CORS**: Configurado para `http://localhost:4200` (ajustar para produ√ß√£o)
- **Trusted Proxies**: Configur√°veis via `TRUSTED_PROXIES` para produ√ß√£o
- **SSL**: Recomendado `DB_SSLMODE=require` em produ√ß√£o

## üèÉ‚Äç‚ôÇÔ∏è Como Executar

### 1. Pr√©-requisitos

- Go 1.24+
- PostgreSQL (ou Docker)
- Make (opcional, mas recomendado)

### 2. Configura√ß√£o do Ambiente

```bash
# Clone o projeto
git clone <repository-url>
cd avantpro-backend

# Instalar ferramentas de desenvolvimento
make install-tools

# Configurar banco de dados com Docker
make db/setup

# Configurar vari√°veis de ambiente
# Crie um arquivo .env na raiz do projeto com as vari√°veis necess√°rias
# (veja a se√ß√£o "Vari√°veis de Ambiente" abaixo)
```

### 3. Executar Aplica√ß√£o

```bash
# Desenvolvimento (com hot reload)
make dev

# Ou executar diretamente
make run

# Build e executar
make build
./bin/avantpro-backend
```

### 4. Acessar Documenta√ß√£o

- **API**: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger/index.html (apenas em desenvolvimento)
- **Health Check**: http://localhost:8080/health
- **Documenta√ß√£o da API**: Todas as rotas documentadas com Swagger/OpenAPI

## üß™ Testes

```bash
# Executar todos os testes
make test

# Testes com cobertura
make test-coverage

# Verifica√ß√£o completa (fmt, vet, lint, test)
make check
```

## üìä Exemplos de Uso

### Autentica√ß√£o

#### Registrar Usu√°rio
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user@example.com",
    "name": "Jo√£o Silva",
    "password": "password123",
    "profile": {
      "street": "Rua das Flores, 123",
      "city": "S√£o Paulo",
      "district": "Centro",
      "zip_code": "01234567",
      "phone": "11987654321"
    }
  }'
```

#### Login
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user@example.com",
    "password": "password123"
  }'
```

#### Solicitar Reset de Senha
```bash
curl -X POST http://localhost:8080/api/v1/auth/password-reset \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com"
  }'
```

### Organiza√ß√µes

#### Criar Organiza√ß√£o
```bash
curl -X POST http://localhost:8080/api/v1/organizations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "name": "Minha Organiza√ß√£o",
    "description": "Descri√ß√£o da organiza√ß√£o"
  }'
```

#### Listar Organiza√ß√µes do Usu√°rio
```bash
curl "http://localhost:8080/api/v1/organizations/my?page=1&limit=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### Convidar Usu√°rio para Organiza√ß√£o
```bash
curl -X POST http://localhost:8080/api/v1/organizations/{id}/invites \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "email": "user@example.com",
    "role": "user"
  }'
```

## üîç Caracter√≠sticas T√©cnicas

### Arquitetura de Tr√™s Camadas

- **Controllers**: Manipula√ß√£o de requisi√ß√µes HTTP e valida√ß√£o de entrada
- **Services**: L√≥gica de neg√≥cio e valida√ß√µes
- **Repositories**: Acesso a dados e opera√ß√µes de banco

### Seguran√ßa

- **Autentica√ß√£o JWT**: Tokens seguros para autentica√ß√£o de usu√°rios
- **Senhas criptografadas**: bcrypt com salt autom√°tico
- **Preven√ß√£o SQL Injection**: Whitelist de campos para ordena√ß√£o
- **CORS configurado**: Controle de origem para requests cross-domain
- **Trusted Proxies**: Configura√ß√£o segura para ambientes de produ√ß√£o
- **Valida√ß√£o completa**: Entrada sanitizada em todos os endpoints

### Valida√ß√µes

- Username deve ser email v√°lido
- Nome: 2-100 caracteres
- Senha: m√≠nimo 6 caracteres
- CEP: exatamente 8 d√≠gitos
- Telefone: 10-15 caracteres

### Error Handling

Implementa RFC 7807 Problem Details para respostas de erro padronizadas:

```json
{
  "type": "https://avantpro-backend.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "username is required",
  "instance": "/api/v1/organizations"
}
```

## üõ† Comandos Dispon√≠veis

```bash
# Desenvolvimento
make dev          # Servidor com hot reload
make run          # Executar aplica√ß√£o
make build        # Compilar aplica√ß√£o

# Testes
make test         # Executar testes
make test-coverage # Testes com cobertura

# Qualidade de C√≥digo
make fmt          # Formatar c√≥digo
make lint         # Linting
make vet          # An√°lise est√°tica
make check        # Verifica√ß√£o completa

# Banco de Dados
make db/setup     # Iniciar PostgreSQL (Docker)
make db/teardown  # Parar PostgreSQL
make db/shell     # Conectar ao banco

# Documenta√ß√£o
make swagger      # Gerar documenta√ß√£o Swagger

# Utilit√°rios
make clean        # Limpar artefatos
make help         # Mostrar ajuda
```

## üìù Licen√ßa

MIT License